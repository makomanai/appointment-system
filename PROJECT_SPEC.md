# 自治体営業支援Webアプリ - 完全仕様書

**作成日**: 2026-01-18  
**プロジェクト名**: Company Pack Web  
**目的**: アポインターが架電のみに集中できる専用Webアプリケーション

---

## 📋 システム全体構成

### スプレッドシート構造

#### 1. マスタースプレッドシート（運営側）
- **topics_master**: CSVから取り込んだ案件の本体
- **companies**: 企業台帳（C001, C002, C003...）
  - company_id
  - company_name
  - company_file_id (企業別スプレッドシートのID)
- **srt_index**: SRT字幕ファイルのインデックス
  - group_id
  - file_id
  - file_name
  - updated_at
- **logs_master**: 各社から回収したログの倉庫
  - logged_at
  - company_id
  - company_row_key
  - call_result
  - memo
  - next_action
  - next_date
  - source_url
  - pulled_at
  - company_file_id

#### 2. データアップロード用スプレッドシート
- 外部データベースからダウンロードしたCSVをアップロード
- **重要**: CSVの型は決まっている（後述）
- これをマスターに取り込む（運営メニュー → 0. CSV取り込み）

#### 3. 企業別スプレッドシート（例: C009_エピックベース株式会社_Pack）
- **queue**: 配布された案件リスト
  - status, priority, call_result, memo, script_draft, excerpt_text, excerpt_range
  - 議会/日付, 議題タイトル, 議題概要, 質問者/回答者, ソースURL
  - next_action, next_date, company_row_key, log_status
  
- **call_view**: 架電ビュー（Webアプリの主要データソース）
  - **A列**: 議会/日付（例: 北海道苫小牧市議会 / 2025/12/09）
  - **B列**: 議題タイトル
  - **C列**: 議題概要
  - **D列**: 質問者/回答者
  - **E列**: ソースURL（1つ目）
  - **F列**: ソースURL（2つ目）
  - **G列**: 抜粋期間
  - **H列**: 抜粋テキスト(B9) ← **左パネルに表示**
  - **I列**: AI要約(B10)
  - **K列**: AI台本(B12) ← **中央パネルに表示**
  - **M列**: 確定関連(B14)
  - **O列**: 脚本ベース(script_draft) ← **中央パネルの最終スクリプト**
  - 右側列: status, priority, call_result, next_action, next_date, memo

- **script_base**: スクリプトベース
- **log**: 架電結果ログ

---

## 📥 CSV取り込み仕様

### CSVの型は決まっている

**重要事項**: 
- 取り込むCSVのカラム構成とデータ型は固定
- システムはこの型に依存している
- CSVフォーマット変更時は全体に影響

**想定される列（確認が必要）**:
```
- 議会名
- 開催日
- 議題タイトル
- 議題概要
- 質問者
- 回答者
- ソースURL
- 抜粋テキスト
- その他...
```

**※ 実際のCSVサンプルまたは列定義を後で追加する**

---

## 🏢 **【重要】マルチテナント対応 - 企業選択機能**

### 前提条件（絶対に忘れてはいけない）

**各企業ごとに独立したスプレッドシートが存在する**

システムには複数の企業（クライアント）が存在し、それぞれが独立した案件リストを持っています：

```
企業一覧の例:
- C001_aitegrity_Pack
- C002_ウルフカムイ_Pack
- C003_アクセリア_Pack
- C004_Adora_Pack
- C005_AiCAN_Pack
- C006_トレミール_Pack
- C007_rerate_Pack
- C008_ミライズエネチェンジ_Pack
- C009_エピックベース株式会社_Pack
- C010_アクセリア_Pack
...
```

### 重要な仕様

#### 1. **アポインターは複数企業のリストから選択できる必要がある**

**背景**:
- アポインターは1社専属ではなく、複数の企業の案件を担当する
- その日の状況に応じて、どの企業の案件に架電するかを自分で判断・選択する
- 企業Aの案件を5件対応した後、企業Bの案件に切り替えることもある

**必須機能**:
1. **企業選択画面**（ログイン後またはダッシュボード）
   - マスタースプレッドシートの`companies`シートから企業一覧を取得
   - アポインターが担当する企業を一覧表示
   - 企業を選択すると、その企業専用の案件リストを表示

2. **企業の切り替え機能**
   - 作業中でも別の企業に切り替え可能
   - 切り替え時は現在の作業内容を保存
   - ヘッダーに現在選択中の企業名を表示

3. **企業ごとのデータ分離**
   - 企業Aの案件と企業Bの案件は完全に分離
   - 各企業のスプレッドシート（company_file_id）から独立してデータ取得
   - ログも企業別に保存（company_idで識別）

#### 2. **データフローの詳細**

```
【アポインターの作業フロー】

1. ログイン
   ↓
2. 企業選択画面
   - 担当可能な企業一覧を表示
   - 例: C001_aitegrity, C008_ミライズエネチェンジ, C009_エピックベース
   ↓
3. 企業を選択（例: C009_エピックベース）
   ↓
4. 選択した企業のスプレッドシートから案件一覧を取得
   - マスターの companies シートから company_file_id を取得
   - そのスプレッドシートの call_view または queue から案件を読み込み
   - フィルタ: status = "未着手" の案件のみ表示
   ↓
5. 案件を選択して架電
   - 3カラムレイアウトで詳細表示
   - スクリプト表示、結果入力
   ↓
6. 結果を保存
   - その企業のスプレッドシートの log シートに保存
   - company_row_key で案件を識別
   ↓
7. 次の案件へ、または別の企業に切り替え
```

#### 3. **実装上の注意点**

**NG（やってはいけないこと）**:
- ❌ 企業IDをハードコーディング
- ❌ 全企業の案件を1つのリストに混ぜる
- ❌ 企業の切り替えなしに固定

**OK（正しい実装）**:
- ✅ 企業選択を必須フローにする
- ✅ 選択した企業のスプレッドシートIDを動的に取得
- ✅ セッションやローカルストレージで選択中の企業を保持
- ✅ 企業切り替えボタンを常に表示

#### 4. **UI設計**

**オプションA: 企業選択→案件一覧の2ステップ**
```
画面1: 企業選択
┌─────────────────────────────┐
│ どの企業の案件に対応しますか？  │
│                                │
│ ☐ C001_aitegrity              │
│ ☐ C008_ミライズエネチェンジ     │
│ ☑ C009_エピックベース          │ ← 選択
│ ☐ C010_アクセリア              │
│                                │
│ [決定]ボタン                   │
└─────────────────────────────┘

画面2: 案件一覧（3カラムレイアウト）
ヘッダー: 現在の企業: C009_エピックベース [変更]
```

**オプションB: サイドバー方式**
```
┌────────┬──────────────────────┐
│企業一覧│  3カラムレイアウト      │
│        │                       │
│C001    │  左 ｜ 中央 ｜ 右     │
│C008    │                       │
│►C009   │  案件の詳細表示        │
│C010    │                       │
└────────┴──────────────────────┘
```

#### 5. **データ構造**

```typescript
// マスター companies シートの構造
interface Company {
  company_id: string;        // 例: "C009"
  company_name: string;      // 例: "エピックベース株式会社"
  company_file_id: string;   // 企業別スプレッドシートのID
  owner: string;             // 管理者
}

// アポインターのセッション
interface Session {
  appointerId: string;
  selectedCompanyId: string;  // 現在選択中の企業ID
  availableCompanies: string[]; // 担当可能な企業ID一覧
}

// 案件取得時のパラメータ
interface FetchCasesParams {
  companyId: string;          // 必須: どの企業の案件か
  spreadsheetId: string;      // 企業のスプレッドシートID
  status?: string;            // フィルタ: "未着手" など
  limit?: number;
}
```

---

## 🎨 Webアプリ UI仕様

### コンセプト
- **「1画面・1コール」**
- 余計な情報は隠す
- 必要な情報とスクリプトだけを美しく表示
- カード型UI（Tinderライク）
- **複数企業の案件をシームレスに切り替え可能**

### 3カラムレイアウト

#### 左パネル：根拠・リサーチ
**表示内容**:
- 議会/日付（A列）← 大きく表示
- 議題タイトル（B列）
- 議題概要（C列）
- 質問者/回答者（D列）
- ソースURL（E列, F列）← リンク
- **抜粋テキスト(B9)（H列）** ← メイン表示
- AI要約(B10)（I列）

**検索ボタン機能**:
```javascript
// 議会/日付から自治体名を抽出（例: "北海道苫小牧市議会" → "北海道苫小牧市"）
ボタン1: Google検索 "[自治体名] 担当課 電話番号 一覧"
ボタン2: Google検索 "[自治体名] 事務分掌 業務内容"
→ 新しいタブで開く
```

**キーワードハイライト**:
- 商材関連キーワードを自動検出してハイライト表示

#### 中央パネル：AIスクリプト
**表示内容**:
- **AI台本(B12)（K列）** または
- **脚本ベース(script_draft)（O列）**

**ステップ表示**:
スクリプトを以下のステップに分割表示:
1. 【受付】担当者指名
2. 【係長】共感・引用
3. 【打診】ハードル下げ
4. 【フェーズ確認】
5. 【切り返し】

**UI**:
- タブ切り替え、またはスクロール追従
- ステップごとに表示/非表示

**AI生成ボタン**:
- ページを開いた瞬間に自動生成、または
- 手動で「AI生成」ボタンをクリック

#### 右パネル：結果入力
**フォーム項目**:
```typescript
{
  status: "未着手 | 対応中 | 完了", // プルダウン（必須）
  priority: "A | B | C", // プルダウン
  call_result: string, // テキストエリア
  next_action: string, // プルダウン
  next_date: Date, // 日付ピッカー
  memo: string // テキストエリア
}
```

**「保存して次へ」ボタン**:
- スプレッドシート（logシート）に書き込み
- 即座に次のリスト（次の案件）に切り替わる
- 待ち時間をゼロにする（ローディング表示なし）

---

## 🤖 AI生成ロジック（プロンプトエンジニアリング）

### ペルソナ
- 元自治体職員
- 企業と自治体の連携コーディネーター

### 思考プロセス
- 答弁者リストから商材に最適な担当者（課長/係長）を推論
- 担当者を指名する

### 禁止ワード
- 「お繋ぎします」
- 「営業です」

### 必須ワード
- 「選択肢の一つとして」
- 「調査の一環として」
- 「お話だけでも」

### 構成
1. 受付: 担当者指名
2. 係長: 共感・引用（議事録から）
3. 打診: ハードル下げ
4. 切り返し

---

## 🔄 データフロー

### 運用フロー
```
1. CSVアップロード
   → データアップロード用スプレッドシート

2. CSV取り込み（運営メニュー → 0. CSV取り込み）
   → topics_master（マスター）

3. 企業ファイルへ配布 Push（運営メニュー → 2. 企業ファイルへ配布）
   → 企業別シートのqueue
   → dispatch_status が SENT になる

4. Webアプリ表示
   → call_viewから読み取り
   → アポインターが架電

5. 架電結果保存
   → logシートに書き込み

6. 企業ログ吸い上げ Pull（運営メニュー → 3. 企業ログを吸い上げ）
   → logs_masterに集約
```

### データ連携仕様
- **リスト取得**: queueシート or call_viewシートから「status=未着手」の行を取得
- **排他制御**: 作業中フラグで重複架電を防ぐ（GAS側で実装）
- **商材情報**: B23（商材情報）をLocalStorageまたは設定画面で保持
- **データ書き込み**: company_row_keyで行を特定して結果を書き戻す

---

## 🛠️ 技術スタック

### Frontend
- **Framework**: Next.js 14+ (App Router)
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **Icons**: Lucide React
- **State Management**: React Hooks + LocalStorage

### Backend
- **Google Apps Script (GAS)**
  - スプレッドシートのデータをJSONとして吐き出し
  - 結果を受け取るAPIとして機能
  - DO_GET: データ取得
  - DO_POST: データ保存

### AI Engine
- **OpenAI API (gpt-4o)**
  - Webアプリ側（Next.js API Routes）から直接呼び出し
  - GAS経由だと遅いため、フロントエンド側で処理

### Hosting
- **Vercel**（推奨）
  - 高速・安定
  - Next.jsとの相性が良い

---

## 📁 ディレクトリ構成

```
appointment-system/
├── app/
│   ├── api/
│   │   ├── generate-script/route.ts   # AI生成API
│   │   └── sheets/route.ts            # スプレッドシート連携API
│   ├── components/
│   │   ├── LeftPanel.tsx              # 自治体情報
│   │   ├── CenterPanel.tsx            # AIスクリプト
│   │   └── RightPanel.tsx             # 結果入力
│   ├── lib/
│   │   ├── openai.ts                  # OpenAI設定
│   │   └── sheets.ts                  # GAS連携
│   ├── globals.css                    # Tailwind CSS
│   ├── layout.tsx                     # ルートレイアウト
│   └── page.tsx                       # メインページ
├── .env.local                         # 環境変数
├── package.json
├── tsconfig.json
├── tailwind.config.ts
└── next.config.mjs
```

---

## 🚨 重要な制約・注意事項

### スプレッドシート運用の絶対NG
1. **topics_master の列名（1行目）を変更・並べ替え**
   - スクリプトが列名で探してるので壊れます

2. **srt_index の A列(group_id) と B列(file_id) を手でいじる**
   - SRT取得がズレて、別の字幕が出ます

3. **topics_master の行を "並べ替え" して運用する**
   - company_row_key と配布/ログの整合が崩れやすい
   - 並べ替えしたくなったら「フィルタ表示」で見る

4. **dispatch_status を手で変更**
   - Push/Pullの判定に使ってるので、意図せず再送/未送扱いになります

### データ削除のルール
- **company_row_key が入った行の削除禁止**（ログと突合できなくなる）
- **company_file_id が入っている行の削除禁止**（どの会社に配布したか追えなくなる）
- 視認性を上げたい場合は「削除」ではなく「フィルタ表示」または「列の非表示」を使う

---

## ✅ 実装チェックリスト

### Phase 0: 企業選択機能（優先度：最高 - 必須）
**🚨 この機能なしではシステムが成立しない 🚨**

- [ ] **企業選択画面の実装**
  - [ ] マスタースプレッドシート companies シートからの企業一覧取得
  - [ ] 企業一覧の表示UI
  - [ ] 企業選択機能
  - [ ] 選択した企業の company_file_id 取得
  
- [ ] **企業切り替え機能**
  - [ ] ヘッダーに現在選択中の企業名を表示
  - [ ] 企業切り替えボタン
  - [ ] 切り替え時の状態保存（LocalStorage または Session）
  
- [ ] **企業ごとのデータ取得**
  - [ ] 選択した企業のスプレッドシートから call_view/queue を取得
  - [ ] 企業IDに基づくフィルタリング
  - [ ] エラーハンドリング（企業が見つからない場合など）

- [ ] **GAS API: 企業マスター取得**
  - [ ] GET /api/companies - 企業一覧を返す
  - [ ] レスポンス: company_id, company_name, company_file_id

### Phase 1: UI実装（優先度：高）
- [ ] 左パネル: call_viewのデータ表示
  - [ ] 議会/日付の表示
  - [ ] 議題タイトル・概要の表示
  - [ ] 抜粋テキスト(B9)の表示
  - [ ] 検索ボタン×2（Google検索）
  - [ ] キーワードハイライト
  
- [ ] 中央パネル: AI台本のステップ表示
  - [ ] AI台本(B12)の表示
  - [ ] ステップ分割表示（受付/係長/打診/フェーズ確認/切り返し）
  - [ ] タブまたはスクロールUI
  
- [ ] 右パネル: フォーム実装
  - [ ] statusプルダウン（未着手/対応中/完了）
  - [ ] priorityプルダウン（A/B/C）
  - [ ] call_resultテキストエリア
  - [ ] next_actionプルダウン
  - [ ] next_date日付ピッカー
  - [ ] memoテキストエリア
  - [ ] 「保存して次へ」ボタン

### Phase 2: GAS連携（優先度：高）
- [ ] GAS API作成
  - [ ] DO_GET: call_viewからデータ取得
  - [ ] DO_POST: logシートへ保存
  - [ ] 排他制御（作業中フラグ）
  
- [ ] Next.js API Routes実装
  - [ ] /api/sheets/route.ts: GAS連携
  - [ ] データ取得・保存のエラーハンドリング

### Phase 3: AI機能（優先度：中）
- [ ] OpenAI API連携
  - [ ] /api/generate-script/route.ts
  - [ ] プロンプトエンジニアリング実装
  - [ ] ペルソナ・禁止ワード・必須ワードの組み込み

### Phase 4: 機能拡張（優先度：中）
- [ ] 次へボタン（次の案件に移動）
- [ ] 商材情報の保存（LocalStorage）
- [ ] カード型UI（Tinderライク）の実装
- [ ] ローディング状態の最適化

### Phase 5: デプロイ・運用（優先度：低）
- [ ] Vercelデプロイ
- [ ] 環境変数の設定
- [ ] エラーロギング
- [ ] パフォーマンス最適化

---

## 📝 未確認事項（後で確認が必要）

1. **CSVの型定義**
   - 実際のCSVサンプルファイル
   - 列名の正確な定義
   - データ型の仕様

2. **商材情報（B23）の詳細**
   - どのような情報が入っているか
   - フォーマット

3. **next_actionの選択肢**
   - プルダウンに表示する具体的な選択肢

4. **答弁者リストの構造**
   - AIが参照する答弁者データの形式

5. **Google Apps ScriptのエンドポイントURL**
   - 実際のスプレッドシートID
   - デプロイ済みのGAS URL

---

## 🔐 セキュリティ・認証

- [ ] 企業別のアクセス制限
- [ ] ログイン機能（必要に応じて）
- [ ] APIキーの安全な管理
- [ ] スプレッドシートへのアクセス権限管理

---

## 📞 連絡事項

**重要**: 
- この仕様書は合意事項として記録されています
- 仕様変更がある場合は、必ずこのファイルを更新してください
- 「言った言わない」を防ぐため、全ての合意事項をここに記載します

**作成者**: Claude  
**承認者**: （記入してください）  
**最終更新**: 2026-01-18 23:05 JST  
**重要な更新**: マルチテナント対応（企業選択機能）の仕様を追加

---

## 📌 メモ欄

### 重要事項（絶対に忘れない）
1. **CSVの型は決まっている**（重要）
2. **各企業ごとに独立したスプレッドシートが存在する**（最重要）
3. **アポインターは複数企業のリストから選択できる必要がある**（必須機能）

### 実装時の注意
- 企業選択機能は Phase 0（最優先）として実装する
- 企業IDのハードコーディングは絶対NG
- 企業切り替えは作業中でも可能にする

### 今後確認が必要な項目
- アポインターの権限管理（どの企業にアクセスできるか）
- 企業ごとの案件数の上限
- 同時に複数企業の案件を開けるか（タブ機能）
